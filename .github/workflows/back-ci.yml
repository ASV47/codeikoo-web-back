name: Deploy Backend (.NET) to Elastic Beanstalk

'on':
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: eu-central-1
  EB_APP_NAME: codeikoo-backend
  EB_ENV_NAME: codeikoo-backend-dotnet-prod
  

  PROJECT_PATH: Codeikoo-ServerSide/Academy.Application/Academy.Application.csproj

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Find WEB csproj + Publish (guaranteed DLL name)
        shell: bash
        run: |
          set -e

          echo "== csproj files =="
          find . -maxdepth 12 -name "*.csproj" -print

          # لازم Web SDK
          WEB_CSPROJ="$(grep -RIl --include "*.csproj" "Microsoft.NET.Sdk.Web" . | head -n 1)"
          PREF="$(grep -RIl --include "*.csproj" "Microsoft.NET.Sdk.Web" . | grep -i "Academy.Web" | head -n 1 || true)"
          if [ -n "$PREF" ]; then WEB_CSPROJ="$PREF"; fi

          if [ -z "$WEB_CSPROJ" ]; then
            echo "❌ No Web csproj found (Microsoft.NET.Sdk.Web)."
            exit 1
          fi

          echo "✅ Using WEB_CSPROJ=$WEB_CSPROJ"

          dotnet restore "$WEB_CSPROJ"
          dotnet publish "$WEB_CSPROJ" -c Release -o publish

          echo "== publish output (first 200) =="
          ls -la publish | head -n 200

          # ✅ استخرج اسم التطبيق الحقيقي من runtimeconfig
          RUNTIMECONFIG="$(ls publish/*.runtimeconfig.json | head -n 1)"
          if [ -z "$RUNTIMECONFIG" ]; then
            echo "❌ No runtimeconfig found in publish output"
            exit 1
          fi

          APP_NAME="$(basename "$RUNTIMECONFIG" .runtimeconfig.json)"
          echo "✅ Detected APP_NAME=$APP_NAME"

          # ✅ Procfile يشغل الـ DLL الحقيقي + يربط على 0.0.0.0:5000
          echo "web: dotnet ${APP_NAME}.dll --urls http://0.0.0.0:5000" > publish/Procfile

          cd publish
          zip -r ../app.zip .
          cd ..




      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_GHA_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Upload + Deploy
        run: |
          set -e
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          EB_BUCKET="elasticbeanstalk-${AWS_REGION}-${ACCOUNT_ID}"

          VERSION="${GITHUB_SHA}"
          KEY="releases/${VERSION}.zip"

          aws s3 mb "s3://${EB_BUCKET}" --region "${AWS_REGION}" || true
          aws s3 cp app.zip "s3://${EB_BUCKET}/${KEY}"

          aws elasticbeanstalk create-application-version \
            --application-name "${EB_APP_NAME}" \
            --version-label "${VERSION}" \
            --source-bundle S3Bucket="${EB_BUCKET}",S3Key="${KEY}"

          aws elasticbeanstalk update-environment \
            --environment-name "${EB_ENV_NAME}" \
            --version-label "${VERSION}"
